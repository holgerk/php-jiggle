#!/usr/bin/env php
<?php

//
// extract examples from test and update readme
$readme = __DIR__ . '/README.md';
$test = __DIR__ . '/test/JiggleTest.php';

$testContent = file_get_contents($test);
preg_match_all(
    "#" .
    "// \<example: (?<title>[^\n]+)" .
    "(?<code>.*?)" .
    "// example>" .
    "#sim", $testContent, $matches);
$titles = $matches['title'];
$codes = $matches['code'];

$content = '';
foreach ($titles as $i => $title) {
    $code = $codes[$i];
    $code =
        implode("\n",
            array_map(function ($line) {
                $line = substr($line, 8);
                // replace assertEquals with echo statement for better readability
                if (preg_match("#assertEquals\((?<expected>[^,]+), (?<actual>.+)\);#", $line, $matches)) {
                    return "echo $matches[actual]; // => $matches[expected]";
                }
                return $line;
            }, explode("\n", $code)));
    $content .= "### $title\n";
    $content .= "```php";
    $content .= "$code";
    $content .= "```\n\n";
}
$readmeContent = file_get_contents($readme);
$readmeContent = preg_replace(
    "#\<!-- START AUTOGENERATED EXAMPLES --\>.+?\<!-- END AUTOGENERATED EXAMPLES --\>#sim",
    "<!-- START AUTOGENERATED EXAMPLES -->\n$content\n<!-- END AUTOGENERATED EXAMPLES -->",
    $readmeContent);

//
// extract method doc from code
$content = '';
require_once __DIR__ . '/src/Jiggle.php';
$lines = file(__DIR__ . '/src/Jiggle.php');

$reflection = new ReflectionClass('Jiggle');
foreach ($reflection->getMethods() as $method) {
    if (!$method->isPublic()) {
        continue;
    }
    $comment = $method->getDocComment();
    $comment = trim(trim($comment, '/*'));
    if (!$comment) {
        continue;
    }
    if (strpos($comment, '@deprecated') !== false) {
        continue;
    }
    $comment = implode("\n", array_map(function($line) {
        return preg_replace('/^@(\w+) +/', ' * **\1** ', ltrim($line, ' *'));
    }, explode("\n", $comment)));
    preg_match('/function (?<signature>[^{]+?) *{/', $lines[$method->getStartLine() - 1], $matches);
    $content .= '### ' . $matches['signature'] . "\n";
    $content .= $comment . "\n\n";
}
$readmeContent = preg_replace(
    "#\<!-- START AUTOGENERATED METHODS --\>.+?\<!-- END AUTOGENERATED METHODS --\>#sim",
    "<!-- START AUTOGENERATED METHODS -->\n$content\n<!-- END AUTOGENERATED METHODS -->",
    $readmeContent);

//
// write
file_put_contents($readme, $readmeContent);

